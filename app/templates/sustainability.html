{% extends "base.html" %} {% block title %}Sustainability Insights - Food
Recommender System{% endblock %} {% block content %}
<!-- Page Header -->
<div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-8 mb-8">
  <div class="text-center">
    <h1 class="text-4xl font-bold text-gray-900 mb-4">
      <i class="fas fa-leaf text-success-600 mr-3"></i>
      Sustainability Insights
    </h1>
    <p class="text-xl text-gray-700 max-w-3xl mx-auto">
      Discover eco-friendly food choices and understand environmental impact of
      your food selections
    </p>
  </div>
</div>

<!-- Quick Stats -->
<div class="grid md:grid-cols-4 gap-6 mb-8">
  <div class="bg-white rounded-lg shadow-md p-6 text-center">
    <div
      class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <i class="fas fa-leaf text-green-600 text-xl"></i>
    </div>
    <h3 class="text-2xl font-bold text-gray-900">A-Grade</h3>
    <p class="text-gray-600">Eco-Score Products</p>
  </div>
  <div class="bg-white rounded-lg shadow-md p-6 text-center">
    <div
      class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <i class="fas fa-recycle text-blue-600 text-xl"></i>
    </div>
    <h3 class="text-2xl font-bold text-gray-900">Recyclable</h3>
    <p class="text-gray-600">Packaging Options</p>
  </div>
  <div class="bg-white rounded-lg shadow-md p-6 text-center">
    <div
      class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <i class="fas fa-seedling text-yellow-600 text-xl"></i>
    </div>
    <h3 class="text-2xl font-bold text-gray-900">Organic</h3>
    <p class="text-gray-600">Certified Products</p>
  </div>
  <div class="bg-white rounded-lg shadow-md p-6 text-center">
    <div
      class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <i class="fas fa-globe text-purple-600 text-xl"></i>
    </div>
    <h3 class="text-2xl font-bold text-gray-900">Local</h3>
    <p class="text-gray-600">Sourced Products</p>
  </div>
</div>

<!-- Sustainability Filters -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
  <div class="border-b border-gray-200 pb-4 mb-6">
    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
      <i class="fas fa-filter text-success-600 mr-3"></i>
      Sustainability Filters
    </h2>
    <p class="text-gray-600 mt-1">
      Find products that match your environmental values
    </p>
  </div>

  <form
    id="sustainabilityFilters"
    onsubmit="loadSustainabilityData(event)"
    class="space-y-6"
  >
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Eco-Score Filter -->
      <div>
        <label
          for="ecoScoreFilter"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          <i class="fas fa-star text-green-600 mr-1"></i>
          Eco-Score Minimum
        </label>
        <select
          id="ecoScoreFilter"
          name="eco_score_min"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-success-500 focus:border-success-500"
        >
          <option value="">Any score</option>
          <option value="A">A - Excellent</option>
          <option value="B">B - Good</option>
          <option value="C">C - Fair</option>
          <option value="D">D - Poor</option>
        </select>
      </div>

      <!-- Packaging Filter -->
      <div>
        <label
          for="packagingFilter"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          <i class="fas fa-recycle text-blue-600 mr-1"></i>
          Packaging Type
        </label>
        <select
          id="packagingFilter"
          name="packaging_preference"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-success-500 focus:border-success-500"
        >
          <option value="">Any packaging</option>
          <option value="recyclable">Recyclable</option>
          <option value="biodegradable">Biodegradable</option>
          <option value="minimal">Minimal packaging</option>
          <option value="reusable">Reusable containers</option>
        </select>
      </div>
      <!-- Origin Filter -->
      <div>
        <label
          for="countryFilter"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          <i class="fas fa-globe text-purple-600 mr-1"></i>
          Origin Preference
        </label>
        <select
          id="countryFilter"
          name="origin_country"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-success-500 focus:border-success-500"
        >
          <option value="">Any country</option>
          <option value="en:france">France</option>
          <option value="en:united-states">United States</option>
          <option value="en:spain">Spain</option>
          <option value="en:germany">Germany</option>
          <option value="en:world">World</option>
          <option value="en:belgium">Belgium</option>
          <option value="en:switzerland">Switzerland</option>
          <option value="en:italy">Italy</option>
          <option value="en:united-kingdom">United Kingdom</option>
          <option value="en:morocco">Morocco</option>
          <option value="en:netherlands">Netherlands</option>
          <option value="en:austria">Austria</option>
          <option value="en:portugal">Portugal</option>
          <option value="en:canada">Canada</option>
          <option value="en:poland">Poland</option>
        </select>
      </div>
      <!-- Category Filter -->
      <div>
        <label
          for="categoryFilter"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          <i class="fas fa-tags text-orange-600 mr-1"></i>
          Product Category
        </label>
        <select
          id="categoryFilter"
          name="category"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-success-500 focus:border-success-500"
        >
          <option value="">All categories</option>
          <option value="en:groceries">Groceries</option>
          <option value="en:beverages">Beverages</option>
          <option value="en:sweetened-beverages">Sweetened Beverages</option>
          <option value="en:snacks">Snacks</option>
          <option value="en:biscuits">Biscuits</option>
          <option value="en:candies">Candies</option>
          <option value="en:dark-chocolates">Dark Chocolates</option>
          <option value="en:frozen-foods">Frozen Foods</option>
          <option value="en:cheeses">Cheeses</option>
          <option value="en:breads">Breads</option>
          <option value="en:salads">Salads</option>
          <option value="en:virgin-olive-oils">Virgin Olive Oils</option>
          <option value="en:yogurts">Yogurts</option>
          <option value="en:breakfast-cereals">Breakfast Cereals</option>
          <option value="en:plant-based-beverages">
            Plant Based Beverages
          </option>
        </select>
      </div>
    </div>

    <!-- Product Count Selection -->
    <div class="border-t border-gray-200 pt-6">
      <div class="max-w-md mx-auto">
        <label
          for="productLimit"
          class="block text-sm font-medium text-gray-700 mb-2 text-center"
        >
          <i class="fas fa-list-ol text-indigo-600 mr-1"></i>
          Number of Products to Display
        </label>
        <select
          id="productLimit"
          name="limit"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-success-500 focus:border-success-500"
        >
          <option value="5">5 products</option>
          <option value="10" selected>10 products</option>
          <option value="25">25 products</option>
          <option value="50">50 products</option>
          <option value="100">100 products</option>
        </select>
      </div>
    </div>

    <div class="text-center">
      <button
        type="submit"
        class="inline-flex items-center px-8 py-3 bg-success-600 text-white font-medium rounded-lg hover:bg-success-700 transition-colors"
      >
        <i class="fas fa-search mr-2"></i>
        Explore Sustainable Options
      </button>
    </div>
  </form>
</div>

<!-- Sustainability Tips -->
<div class="grid lg:grid-cols-3 gap-8 mb-8">
  <div class="bg-white rounded-lg shadow-md p-6">
    <div
      class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-4"
    >
      <i class="fas fa-leaf text-green-600 text-xl"></i>
    </div>
    <h3 class="text-xl font-bold text-gray-900 mb-3">Choose Eco-Friendly</h3>
    <p class="text-gray-600 mb-4">
      Look for products with high Eco-Score ratings (A or B) to minimize
      environmental impact.
    </p>
    <ul class="text-sm text-gray-600 space-y-1">
      <li>• Lower carbon footprint</li>
      <li>• Sustainable farming practices</li>
      <li>• Biodiversity conservation</li>
    </ul>
  </div>

  <div class="bg-white rounded-lg shadow-md p-6">
    <div
      class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4"
    >
      <i class="fas fa-recycle text-blue-600 text-xl"></i>
    </div>
    <h3 class="text-xl font-bold text-gray-900 mb-3">Sustainable Packaging</h3>
    <p class="text-gray-600 mb-4">
      Opt for products with recyclable or minimal packaging to reduce waste.
    </p>
    <ul class="text-sm text-gray-600 space-y-1">
      <li>• Recyclable materials</li>
      <li>• Reduced packaging volume</li>
      <li>• Reusable containers</li>
    </ul>
  </div>

  <div class="bg-white rounded-lg shadow-md p-6">
    <div
      class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-4"
    >
      <i class="fas fa-map-marker-alt text-purple-600 text-xl"></i>
    </div>
    <h3 class="text-xl font-bold text-gray-900 mb-3">Local Sourcing</h3>
    <p class="text-gray-600 mb-4">
      Support local producers to reduce transportation emissions and boost local
      economy.
    </p>
    <ul class="text-sm text-gray-600 space-y-1">
      <li>• Reduced transport emissions</li>
      <li>• Support local farmers</li>
      <li>• Fresher products</li>
    </ul>
  </div>
</div>

<!-- Results Section -->
<div id="sustainability-results" class="hidden mb-8">
  <div class="bg-white rounded-lg shadow-md">
    <div class="border-b border-gray-200 px-6 py-4">
      <h2 class="text-2xl font-bold text-gray-900 flex items-center">
        <i class="fas fa-chart-bar text-success-600 mr-3"></i>
        Sustainability Results
      </h2>
    </div>
    <div id="results-content" class="p-6">
      <!-- Results will be loaded here -->
    </div>
  </div>
</div>

<!-- Educational Content -->
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-8">
  <div class="text-center mb-6">
    <h2
      class="text-2xl font-bold text-gray-900 flex items-center justify-center"
    >
      <i class="fas fa-graduation-cap text-primary-600 mr-3"></i>
      Learn About Food Sustainability
    </h2>
    <p class="text-gray-600 mt-2">
      Understanding the environmental impact of your food choices
    </p>
  </div>

  <div class="grid md:grid-cols-3 gap-6">
    <div class="bg-white rounded-lg p-6 shadow-sm">
      <div
        class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-4"
      >
        <i class="fas fa-leaf text-green-600 text-xl"></i>
      </div>
      <h3 class="text-lg font-bold text-gray-900 mb-3">Eco-Scores Explained</h3>
      <p class="text-gray-600 text-sm">
        Eco-Scores rate environmental impact from A (best) to E (worst),
        considering carbon footprint, packaging, and production methods.
      </p>
    </div>

    <div class="bg-white rounded-lg p-6 shadow-sm">
      <div
        class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4"
      >
        <i class="fas fa-recycle text-blue-600 text-xl"></i>
      </div>
      <h3 class="text-lg font-bold text-gray-900 mb-3">
        Sustainable Packaging
      </h3>
      <p class="text-gray-600 text-sm">
        Look for recyclable, biodegradable, or minimal packaging. Reusable
        containers are the most eco-friendly option.
      </p>
    </div>

    <div class="bg-white rounded-lg p-6 shadow-sm">
      <div
        class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-4"
      >
        <i class="fas fa-map-marker-alt text-purple-600 text-xl"></i>
      </div>
      <h3 class="text-lg font-bold text-gray-900 mb-3">Local vs Global</h3>
      <p class="text-gray-600 text-sm">
        Local products typically have lower carbon footprints due to reduced
        transportation distances and fresher ingredients.
      </p>
    </div>
  </div>
</div>

<!-- Environmental Impact Chart -->
<div class="bg-white rounded-lg shadow-md p-6">
  <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
    <i class="fas fa-chart-pie text-success-600 mr-3"></i>
    Environmental Impact Overview
  </h2>

  <div class="grid md:grid-cols-2 gap-8">
    <!-- Impact Categories -->
    <div>
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        Impact Categories
      </h3>
      <div class="space-y-4">
        <div
          class="flex items-center justify-between p-3 bg-green-50 rounded-lg"
        >
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
            <span class="font-medium">Climate Change</span>
          </div>
          <span class="text-green-700 font-medium">Low Impact</span>
        </div>
        <div
          class="flex items-center justify-between p-3 bg-blue-50 rounded-lg"
        >
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
            <span class="font-medium">Water Usage</span>
          </div>
          <span class="text-blue-700 font-medium">Moderate</span>
        </div>
        <div
          class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg"
        >
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
            <span class="font-medium">Land Use</span>
          </div>
          <span class="text-yellow-700 font-medium">Variable</span>
        </div>
        <div
          class="flex items-center justify-between p-3 bg-purple-50 rounded-lg"
        >
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
            <span class="font-medium">Biodiversity</span>
          </div>
          <span class="text-purple-700 font-medium">Protected</span>
        </div>
      </div>
    </div>

    <!-- Sustainability Score Distribution -->
    <div>
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        Eco-Score Distribution
      </h3>
      <div class="space-y-3">
        <div class="flex items-center space-x-3">
          <span
            class="w-8 h-8 bg-green-500 text-white font-bold text-sm rounded-full flex items-center justify-center"
            >A</span
          >
          <div class="flex-1 bg-gray-200 rounded-full h-3">
            <div class="bg-green-500 h-3 rounded-full" style="width: 25%"></div>
          </div>
          <span class="text-sm text-gray-600">25%</span>
        </div>
        <div class="flex items-center space-x-3">
          <span
            class="w-8 h-8 bg-lime-500 text-white font-bold text-sm rounded-full flex items-center justify-center"
            >B</span
          >
          <div class="flex-1 bg-gray-200 rounded-full h-3">
            <div class="bg-lime-500 h-3 rounded-full" style="width: 35%"></div>
          </div>
          <span class="text-sm text-gray-600">35%</span>
        </div>
        <div class="flex items-center space-x-3">
          <span
            class="w-8 h-8 bg-yellow-500 text-white font-bold text-sm rounded-full flex items-center justify-center"
            >C</span
          >
          <div class="flex-1 bg-gray-200 rounded-full h-3">
            <div
              class="bg-yellow-500 h-3 rounded-full"
              style="width: 25%"
            ></div>
          </div>
          <span class="text-sm text-gray-600">25%</span>
        </div>
        <div class="flex items-center space-x-3">
          <span
            class="w-8 h-8 bg-orange-500 text-white font-bold text-sm rounded-full flex items-center justify-center"
            >D</span
          >
          <div class="flex-1 bg-gray-200 rounded-full h-3">
            <div
              class="bg-orange-500 h-3 rounded-full"
              style="width: 10%"
            ></div>
          </div>
          <span class="text-sm text-gray-600">10%</span>
        </div>
        <div class="flex items-center space-x-3">
          <span
            class="w-8 h-8 bg-red-500 text-white font-bold text-sm rounded-full flex items-center justify-center"
            >E</span
          >
          <div class="flex-1 bg-gray-200 rounded-full h-3">
            <div class="bg-red-500 h-3 rounded-full" style="width: 5%"></div>
          </div>
          <span class="text-sm text-gray-600">5%</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Product Details Popup Modal -->
<div
  id="productModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
>
  <div
    class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
  >
    <div class="p-6">
      <!-- Modal Header -->
      <div class="flex justify-between items-start mb-4">
        <h2 id="modalTitle" class="text-xl font-bold text-gray-900">
          Product Details
        </h2>
        <button
          onclick="closeProductModal()"
          class="text-gray-400 hover:text-gray-600 text-xl"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Loading State -->
      <div id="modalLoading" class="text-center py-8">
        <i class="fas fa-spinner fa-spin text-2xl text-success-600 mb-2"></i>
        <p class="text-gray-600">Loading product details...</p>
      </div>

      <!-- Product Content -->
      <div id="modalContent" class="hidden">
        <!-- Product Image -->
        <div class="mb-6 flex justify-center">
          <div id="productImageContainer" class="w-full max-w-xs h-48 sm:h-56">
            <!-- Image will be inserted here -->
          </div>
        </div>

        <!-- Product Name and Brand -->
        <div class="mb-4">
          <h3
            id="productName"
            class="text-lg font-semibold text-gray-900 mb-2"
          ></h3>
          <p id="productBrand" class="text-gray-600"></p>
          <p id="productCode" class="text-sm text-gray-500 mt-1"></p>
        </div>

        <!-- Nutriscore -->
        <div class="mb-4">
          <div class="flex items-center gap-3">
            <span class="text-sm font-medium text-gray-700">Nutri-Score:</span>
            <div id="nutriscoreBadge" class="nutriscore-badge"></div>
          </div>
        </div>

        <!-- Categories -->
        <div class="mb-4">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Categories</h4>
          <p id="productCategories" class="text-gray-600 text-sm"></p>
        </div>

        <!-- Nutritional Information -->
        <div class="mb-4">
          <h4 class="text-sm font-medium text-gray-700 mb-3">
            Nutrition Facts (per 100g)
          </h4>
          <div id="nutritionGrid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <!-- Nutrition items will be inserted here -->
          </div>
        </div>

        <!-- Ingredients -->
        <div class="mb-4">
          <h4 class="text-sm font-medium text-gray-700 mb-2">Ingredients</h4>
          <p
            id="productIngredients"
            class="text-gray-600 text-sm leading-relaxed"
          ></p>
        </div>
      </div>

      <!-- Error State -->
      <div id="modalError" class="hidden text-center py-8">
        <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-2"></i>
        <p class="text-red-600">Failed to load product details</p>
      </div>
    </div>
  </div>
</div>

<style>
  .nutriscore-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    font-weight: bold;
    color: white;
    font-size: 14px;
  }

  .nutriscore-a {
    background-color: #00b04f;
  }
  .nutriscore-b {
    background-color: #85bb2f;
  }
  .nutriscore-c {
    background-color: #ffce00;
    color: #333;
  }
  .nutriscore-d {
    background-color: #ff6600;
  }
  .nutriscore-e {
    background-color: #ff0000;
  }
</style>
{% endblock %} {% block scripts %}
<script>
  function loadSustainabilityData(event) {
    event.preventDefault();

    const form = document.getElementById("sustainabilityFilters");
    const formData = new FormData(form);
    const resultsSection = document.getElementById("sustainability-results");
    const resultsContent = document.getElementById("results-content"); // Show loading state    resultsSection.classList.remove("hidden");
    resultsContent.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-3xl text-success-600 mb-4"></i>
            <p class="text-gray-600">Analyzing sustainable products...</p>
        </div>
    `;

    // Smooth scroll to results section after DOM updates
    setTimeout(() => {
      console.log("Attempting to scroll to results section");
      try {
        // First method: scrollIntoView
        resultsSection.scrollIntoView({
          behavior: "smooth",
          block: "start",
          inline: "nearest",
        });
        console.log("ScrollIntoView initiated successfully");
      } catch (error) {
        console.error("ScrollIntoView error:", error);
        try {
          // Fallback: calculate position and use window.scrollTo
          const rect = resultsSection.getBoundingClientRect();
          const scrollTop =
            window.pageYOffset || document.documentElement.scrollTop;
          const targetPosition = rect.top + scrollTop - 20; // 20px offset from top

          window.scrollTo({
            top: targetPosition,
            behavior: "smooth",
          });
          console.log("Window.scrollTo initiated successfully");
        } catch (fallbackError) {
          console.error("Fallback scroll error:", fallbackError);
          // Final fallback: instant scroll
          resultsSection.scrollIntoView();
        }
      }
    }, 200);

    // Update button to loading state
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.disabled = true;
      submitButton.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
    } // Prepare filter data
    const filters = {
      eco_score_min: formData.get("eco_score_min") || "",
      packaging_preference: formData.get("packaging_preference") || "",
      origin_country: formData.get("origin_country") || "",
      category: formData.get("category") || "",
      limit: parseInt(formData.get("limit")) || 50,
    };

    // Call the sustainability API
    fetch("/api/sustainability/filter", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(filters),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log("Sustainability API Response:", data);
        displaySustainabilityResults(data.products);
        // Reset button state
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML =
            '<i class="fas fa-search mr-2"></i>Explore Sustainable Options';
        }
      })
      .catch((error) => {
        console.error("Error fetching sustainability data:", error);
        resultsContent.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-2xl text-red-500 mb-2"></i>
                <p class="text-red-600">Failed to load sustainability data</p>
                <p class="text-gray-500 text-sm mt-1">${error.message}</p>
            </div>
        `;
        // Reset button state on error
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML =
            '<i class="fas fa-search mr-2"></i>Explore Sustainable Options';
        }
      });
  }

  function displaySustainabilityResults(products) {
    const resultsContent = document.getElementById("results-content");

    if (!products || products.length === 0) {
      resultsContent.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-search text-3xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No Sustainable Products Found</h3>
                <p class="text-gray-600">Try adjusting your filters to find eco-friendly options.</p>
            </div>
        `;
      return;
    }

    let html = `
        <div class="mb-4">
            <h3 class="text-lg font-semibold text-gray-900">
                Found ${products.length} sustainable product${
      products.length !== 1 ? "s" : ""
    }
            </h3>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    `;

    products.forEach((product) => {
      const ecoScore = product.eco_score || "Unknown";
      const sustainabilityScore = product.sustainability_score || 0;
      const scoreColor =
        ecoScore === "A"
          ? "green"
          : ecoScore === "B"
          ? "lime"
          : ecoScore === "C"
          ? "yellow"
          : ecoScore === "D"
          ? "orange"
          : "red";

      const isOrganic = product.is_organic
        ? '<i class="fas fa-leaf text-green-500 mr-1"></i>'
        : "";
      const isLocal = product.is_local
        ? '<i class="fas fa-map-marker-alt text-blue-500 mr-1"></i>'
        : "";

      html += `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="font-bold text-gray-900 text-sm leading-tight">
                        ${product.product_name || "Unknown Product"}
                    </h3>
                    <span class="inline-flex items-center justify-center w-8 h-8 bg-${scoreColor}-500 text-white font-bold rounded-full text-sm ml-2">
                        ${ecoScore}
                    </span>
                </div>
                
                ${
                  product.brands
                    ? `<p class="text-gray-600 text-sm mb-2">${product.brands}</p>`
                    : ""
                }
                
                <div class="space-y-2 text-sm">
                    ${
                      product.categories
                        ? `
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-tags text-orange-600"></i>
                        <span class="text-gray-700 text-xs">${product.categories.substring(
                          0,
                          40
                        )}${product.categories.length > 40 ? "..." : ""}</span>
                    </div>
                    `
                        : ""
                    }
                    
                    ${
                      product.countries
                        ? `
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-globe text-purple-600"></i>
                        <span class="text-gray-700 text-xs">${product.countries.substring(
                          0,
                          30
                        )}${product.countries.length > 30 ? "..." : ""}</span>
                    </div>
                    `
                        : ""
                    }
                    
                    <div class="flex items-center justify-between mt-3 pt-2 border-t border-gray-100">
                        <div class="flex items-center space-x-1">
                            ${isOrganic}${isLocal}
                            <span class="text-gray-600 text-xs">Sustainability Score:</span>
                        </div>
                        <span class="font-bold text-${scoreColor}-600">${sustainabilityScore}/100</span>
                    </div>
                    
                    <div class="mt-2">
                        <button data-product-code="${
                          product.code || product._id || ""
                        }"
                               class="product-details-btn w-full bg-success-600 text-white px-3 py-1 rounded text-xs hover:bg-success-700 transition-colors">
                            <i class="fas fa-eye mr-1"></i>View Details
                        </button>
                    </div>
                </div>
            </div>
        `;
    });

    html += "</div>";
    resultsContent.innerHTML = html;

    // Add event listeners for the new product detail buttons
    document.querySelectorAll(".product-details-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const productCode = this.getAttribute("data-product-code");
        if (productCode) {
          showProductDetails(productCode);
        }
      });
    });
  }
  function showProductDetails(productCode) {
    const modal = document.getElementById("productModal");
    const loading = document.getElementById("modalLoading");
    const content = document.getElementById("modalContent");
    const error = document.getElementById("modalError");

    // Show modal and loading state
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    loading.classList.remove("hidden");
    content.classList.add("hidden");
    error.classList.add("hidden");

    // Fetch product details
    fetch(`/api/product/${productCode}`)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((product) => {
        console.log("API Response received:", product);
        console.log("Image URL from API:", product.image_url);
        populateProductModal(product);
        loading.classList.add("hidden");
        content.classList.remove("hidden");
      })
      .catch((err) => {
        console.error("Error fetching product details:", err);
        loading.classList.add("hidden");
        error.classList.remove("hidden");
      });
  }

  function populateProductModal(product) {
    console.log("=== populateProductModal called ===");
    console.log("Full product object:", product);
    console.log("product.image_url value:", product.image_url);
    console.log("product.image_url type:", typeof product.image_url);
    console.log(
      "product.image_url length:",
      product.image_url ? product.image_url.length : "N/A"
    );

    // Product image
    const imageContainer = document.getElementById("productImageContainer");

    if (product.image_url && product.image_url.trim() !== "") {
      console.log("✅ Image URL is valid, proceeding with loading...");
      console.log("Loading image URL:", product.image_url);

      // Show loading state for image
      imageContainer.innerHTML = `
            <div class="w-full h-full bg-gray-100 rounded-lg flex items-center justify-center">
                <div class="text-center text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p class="text-xs">Loading image...</p>
                </div>
            </div>
        `;

      // Create image element programmatically
      const img = new Image();
      img.className = "w-full h-full object-cover rounded-lg shadow-md";
      img.alt = product.product_name || "Product image";

      // Set crossOrigin to handle CORS issues
      img.crossOrigin = "anonymous";

      img.onload = function () {
        console.log("Image loaded successfully:", this.src);
        imageContainer.innerHTML = "";
        imageContainer.appendChild(this);
      };

      img.onerror = function () {
        console.log("Image failed to load:", this.src);
        console.log("Attempting alternative loading method...");

        // Try loading without crossOrigin
        const img2 = new Image();
        img2.className = "w-full h-full object-cover rounded-lg shadow-md";
        img2.alt = product.product_name || "Product image";

        img2.onload = function () {
          console.log("Image loaded with alternative method:", this.src);
          imageContainer.innerHTML = "";
          imageContainer.appendChild(this);
        };

        img2.onerror = function () {
          console.log("Alternative image loading also failed:", this.src);
          const urlPreview =
            product.image_url.length > 50
              ? product.image_url.substring(0, 50) + "..."
              : product.image_url;

          imageContainer.innerHTML = `
                    <div class="w-full h-full bg-gray-100 rounded-lg flex items-center justify-center">
                        <div class="text-center text-gray-400">
                            <i class="fas fa-image text-3xl mb-2"></i>
                            <p class="text-xs">Image unavailable</p>
                            <p class="text-xs mt-1 text-red-400">URL: ${urlPreview}</p>
                            <button onclick="window.open('${product.image_url}', '_blank')" 
                                    class="text-xs text-blue-500 hover:text-blue-700 mt-1 underline">
                                Open in new tab
                            </button>
                        </div>
                    </div>
                `;
        };

        img2.src = product.image_url;
      };

      // Start loading the image
      img.src = product.image_url;
    } else {
      console.log("❌ No valid image URL found");
      console.log("image_url value:", product.image_url);
      imageContainer.innerHTML = `
            <div class="w-full h-full bg-gray-100 rounded-lg flex items-center justify-center">
                <div class="text-center text-gray-400">
                    <i class="fas fa-image text-3xl mb-2"></i>
                    <p class="text-xs">No image URL provided</p>
                    <p class="text-xs text-red-400 mt-1">Debug: ${JSON.stringify(
                      product.image_url
                    )}</p>
                </div>
            </div>
        `;
    }

    // Product name and brand
    document.getElementById("productName").textContent =
      product.product_name || "N/A";
    document.getElementById("productBrand").textContent =
      product.brands || "N/A";
    document.getElementById("productCode").textContent = `Product Code: ${
      product.code || "N/A"
    }`;

    // Nutriscore
    const nutriscoreBadge = document.getElementById("nutriscoreBadge");
    const grade = (product.nutriscore_grade || "unknown").toLowerCase();
    nutriscoreBadge.textContent = grade.toUpperCase();
    nutriscoreBadge.className = `nutriscore-badge nutriscore-${grade}`;

    // Categories
    document.getElementById("productCategories").textContent =
      product.categories || "N/A";

    // Nutrition facts
    const nutritionGrid = document.getElementById("nutritionGrid");
    nutritionGrid.innerHTML = "";

    const nutritionItems = [
      { label: "Energy", value: product.energy_100g, unit: "kJ" },
      { label: "Fat", value: product.fat_100g, unit: "g" },
      { label: "Carbohydrates", value: product.carbohydrates_100g, unit: "g" },
      { label: "Proteins", value: product.proteins_100g, unit: "g" },
      { label: "Salt", value: product.salt_100g, unit: "g" },
      { label: "Sugars", value: product.sugars_100g, unit: "g" },
      { label: "Fiber", value: product.fiber_100g, unit: "g" },
      { label: "Sodium", value: product.sodium_100g, unit: "g" },
    ];

    nutritionItems.forEach((item) => {
      if (item.value !== null && item.value !== undefined) {
        const nutritionItem = document.createElement("div");
        nutritionItem.className = "bg-gray-50 px-3 py-2 rounded text-center";
        nutritionItem.innerHTML = `
                <div class="text-xs font-medium text-gray-700">${item.label}</div>
                <div class="text-sm font-semibold text-gray-900">${item.value}${item.unit}</div>
            `;
        nutritionGrid.appendChild(nutritionItem);
      }
    });

    // Ingredients
    const ingredients =
      product.ingredients_text || "No ingredient information available";
    document.getElementById("productIngredients").textContent = ingredients;
  }

  function closeProductModal() {
    const modal = document.getElementById("productModal");
    modal.classList.add("hidden");
  }

  // Initialize tooltips or other interactive elements
  document.addEventListener("DOMContentLoaded", function () {
    // Add any initialization code here
  });
</script>
{% endblock %}
